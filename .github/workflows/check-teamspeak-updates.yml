name: Check TeamSpeak Updates

on:
  schedule:
    # Runs Sunday at 8:00 UTC.
    - cron: '0 8 * * 0'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new TeamSpeak version
        id: check-version
        run: |
          # Get current version from Dockerfile
          CURRENT_VERSION=$(grep -oP 'teamspeak3-server_linux_amd64-\K[0-9]+\.[0-9]+\.[0-9]+' debian/Dockerfile | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Fetch latest version from TeamSpeak JSON API
          JSON_DATA=$(curl -sL https://www.teamspeak.com/versions/server.json)

          LATEST_VERSION=$(echo "$JSON_DATA" | jq -r '.linux.x86_64.version')
          CHECKSUM=$(echo "$JSON_DATA" | jq -r '.linux.x86_64.checksum')
          DOWNLOAD_URL=$(echo "$JSON_DATA" | jq -r '.linux.x86_64.mirrors["teamspeak.com"]')

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

          echo "Current version: $CURRENT_VERSION"
          echo "Latest version: $LATEST_VERSION"
          echo "Download URL: $DOWNLOAD_URL"
          echo "Checksum: $CHECKSUM"

          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Dockerfile
        if: steps.check-version.outputs.update_available == 'true'
        run: |
          LATEST_VERSION="${{ steps.check-version.outputs.latest_version }}"
          DOWNLOAD_URL="${{ steps.check-version.outputs.download_url }}"
          CHECKSUM="${{ steps.check-version.outputs.checksum }}"

          # Update version in Dockerfile
          sed -i "s|ARG TEAMSPEAK_CHECKSUM=.*|ARG TEAMSPEAK_CHECKSUM=$CHECKSUM|" debian/Dockerfile
          sed -i "s|ARG TEAMSPEAK_URL=.*|ARG TEAMSPEAK_URL=$DOWNLOAD_URL|" debian/Dockerfile

      - name: Create Pull Request
        if: steps.check-version.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update TeamSpeak to version ${{ steps.check-version.outputs.latest_version }}"
          title: "Update TeamSpeak to version ${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## TeamSpeak Update Available

            This automated PR updates TeamSpeak from version ${{ steps.check-version.outputs.current_version }} to ${{ steps.check-version.outputs.latest_version }}.

            ### Changes
            - Updated TeamSpeak version to ${{ steps.check-version.outputs.latest_version }}
            - Updated download URL
            - Updated SHA256 checksum: `${{ steps.check-version.outputs.checksum }}`

            ### Testing
            Please review and test the changes before merging. After merging, a new Docker image will be automatically built and published.

            ---
            *This PR was automatically generated by the Check TeamSpeak Updates workflow.*
          branch: update-teamspeak-${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          labels: |
            automated
            dependencies
            teamspeak-update
